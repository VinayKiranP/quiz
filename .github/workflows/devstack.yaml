name: Devstack CI
on: [ push ]
jobs:
  cancel:
    runs-on: [self-hosted]
    name: Cancel Previous Runs
    if: always()
    steps:
      - uses: styfle/cancel-workflow-action@bb6001c4ea612bf59c3abfc4756fbceee4f870c7
        if: github.ref != 'refs/heads/master'
        name: cancel old workflows
        id: cancel
        with:
          access_token: ${{ github.token }}
      - if: github.ref == 'refs/heads/master'
        name: Don't cancel old workflows
        id: dont_cancel
        run: |
          echo "Don't cancel old workflow"
  build:
    name: Build Quiz App
    runs-on: [ self-hosted ]
    env:
      REPO_NAME: VinayKiranP/quiz
      APP_NAME: quiz
      GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
    steps:
      - name: Login to Harbor
        uses: docker/login-action@v2
        with:
          registry: c.rzp.io
          username: ${{ secrets.HARBOR_DOCKER_USERNAME }}
          password: ${{ secrets.HARBOR_DOCKER_PASSWORD }}
      - name: Setup Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v2
      - name: Build and Push
        uses: docker/build-push-action@v3
        with:
          tags: c.rzp.io/razorpay/cardholder-portal:chp-devstack
          file: Dockerfile
          push: true
          secrets: |
            git_token=${{ secrets.GIT_TOKEN }}
          build-args: |
            GIT_ACTOR=${{ github.actor }}
            STANDALONE_APP_TESTING=true
            BANK_GATEWAY=""